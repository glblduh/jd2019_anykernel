#!/sbin/sh

OUTFD=/proc/self/fd/$2;
JHOME=/tmp/jzhome;
BLOCK=/dev/block/bootdevice/by-name;

ui_print() {
  echo "ui_print $1" >> $OUTFD;
  echo "ui_print" >> $OUTFD;
}

if ! { [ $(getprop ro.product.device) = "kunlun2" ] || [ $(getprop ro.product.device) = "kunlun2_row" ]; } then
  ui_print " This kernel is only available for kunlun2 device!";
  exit 1;
fi

if [ $(getprop ro.build.version.sdk) -lt 30 ]; then
  ui_print " Minimum Available API 30 (Android 11) !";
  exit 1;
fi

s='\\''\\';

ui_print "  __                                    ___       ";
ui_print " /\ \  _                               /\_ \      ";
ui_print " \ \ \/ \     ___   _ __    ___     ___\//\ \     ";
ui_print "  \ \   /    / __ \/\  __\/  _  \  / __ $s \ \    ";
ui_print "   \ \ \ â€” _/\  __/\ \ \/ /\ \/\ \/\  __/ \_\ \_  ";
ui_print "    \ \_\-\_\ \____$s \_\ \ \_\ \_\ \____\/\____\ ";
ui_print "     \/_/\/_/\/____/ \/_/  \/_/\/_/\/____/\/____/ ";
ui_print " ";
ui_print "=================================================";
ui_print " Kernel version   : 4.9.325-jzinferno";
ui_print " Device           : Lenovo Z6 Lite (L38111)";
ui_print " Author           : Zaharchenko (jzinferno)";
ui_print "=================================================";

rm -rf $JHOME;
mkdir -p $JHOME;
unzip -q $3 -d $JHOME;

if [ -f $JHOME/boot.img ]; then
  ui_print " Patching boot image ...";
  dd if=$JHOME/boot.img of=$BLOCK/boot;
else
  ui_print " boot.img not found!";
  exit 1;
fi

echo "progress 1 1" >> $OUTFD;

if [ -f $JHOME/dtbo.img ]; then
  ui_print " Patching dtbo image ...";
  dd if=$JHOME/dtbo.img of=$BLOCK/dtbo;
else
  ui_print " dtbo.img not found!";
fi

rm -rf $JHOME;
exit 0;
